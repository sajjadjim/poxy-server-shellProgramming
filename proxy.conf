
# /etc/squid/squid.conf  (installed by setup_proxy.sh)
# Secure, simple forward proxy with Basic auth, allow/deny lists.
# Listen on port 3128
http_port 3128

# Logging
cache_log /var/log/squid/cache.log
access_log stdio:/var/log/squid/access.log squid

# DNS & performance tweaks (safe defaults)
dns_v4_first on
positive_dns_ttl 1 hour
negative_dns_ttl 5 minutes
pipeline_prefetch on
memory_pools off

# Authentication (Basic with htpasswd file)
auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwd
auth_param basic realm Proxy Login
acl authenticated proxy_auth REQUIRED

# Network ACLs
acl localnet src 10.0.0.0/8     # RFC1918
acl localnet src 172.16.0.0/12  # RFC1918
acl localnet src 192.168.0.0/16 # RFC1918
acl to_localhost dst 127.0.0.0/8 ::1

# Domain lists (managed by project scripts)
acl blocked_sites dstdomain "/etc/squid/blocklist.txt"
acl allowed_sites dstdomain "/etc/squid/allowlist.txt"

# Security: safe request headers
request_header_access Proxy-Authorization allow all
request_header_access All allow all

# Default policy:
# 1) Deny explicit blocklist
http_access deny blocked_sites

# 2) If allowlist has entries, allow only those domains for authenticated users
#    If allowlist is empty, this clause is skipped by default deny-all rule.
#    (We use 'url_regex -i .' trick to test non-emptiness in setup script)
acl allowlist_exists url_regex -i .
%ALLOWLIST_SWITCH%

# 3) Allow localhost for diagnostics
http_access allow localhost

# 4) Allow authenticated users to access anything else (subject to blocklist)
http_access allow authenticated

# 5) Finally deny all other access
http_access deny all

# Caching policy (conservative to avoid surprises)
cache_mem 64 MB
maximum_object_size_in_memory 512 KB
maximum_object_size 32 MB
cache_dir aufs /var/spool/squid 100 16 256

# Refresh patterns
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# Prevent abuse: reasonable limits
client_request_buffer_max_size 20 MB
reply_body_max_size 0 allow all

# IPv6 support (optional; enabled by default on modern Ubuntu)
# disable_ipv6 off
